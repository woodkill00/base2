http:
  routers:
    # Catch-all HTTP -> HTTPS
    http-catchall:
      rule: HostRegexp(`{host:.+}`)
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: noop@internal

    # API: external /api/* -> internal /* (strip /api)
    api:
      rule: Host(`${WEBSITE_DOMAIN}`) && PathPrefix(`/api`)
      priority: 200
      entryPoints:
        - websecure
      middlewares:
        - strip-api-prefix
        - security-headers
        - security-csp
        - rate-limit
        - retry
      tls:
        certResolver: le-staging
      service: api

    # Django admin on admin subdomain (guarded; restrict to /admin paths only)
    django-admin-subdomain:
      rule: Host(`admin.${WEBSITE_DOMAIN}`) && PathPrefix(`/admin`)
      priority: 190
      entryPoints:
        - websecure
      middlewares:
        - security-headers-no-hsts
        - traefik-basic-auth
        - django-admin-allow-ip
      tls:
        certResolver: le-staging
      service: django-admin

    # Optional: Django admin on main domain /admin (guarded)
    django-admin-path:
      rule: Host(`${WEBSITE_DOMAIN}`) && PathPrefix(`/admin`)
      priority: 180
      entryPoints:
        - websecure
      middlewares:
        - security-headers-no-hsts
        - traefik-basic-auth
        - django-admin-allow-ip
      tls:
        certResolver: le-staging
      service: django-admin

    # Django static: /static/* (admin subdomain only; avoids hijacking React /static assets on main domain)
    static-files:
      rule: Host(`admin.${WEBSITE_DOMAIN}`) && PathPrefix(`/static`)
      priority: 195
      entryPoints:
        - websecure
      middlewares:
        - security-headers-no-hsts
      tls:
        certResolver: le-staging
      service: django-static

    # React frontend: catch-all on HTTPS
    frontend-react:
      rule: (Host(`${WEBSITE_DOMAIN}`) || Host(`www.${WEBSITE_DOMAIN}`)) && PathPrefix(`/`)
      priority: 100
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - security-csp
      tls:
        certResolver: le-staging
      service: frontend-react

    # FastAPI Swagger UI on swagger subdomain (docs-only paths)
    swagger-docs:
      rule: Host(`swagger.${WEBSITE_DOMAIN}`) && (PathPrefix(`/docs`) || Path(`/openapi.json`) || PathPrefix(`/redoc`))
      priority: 205
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - security-csp-swagger
        - rate-limit
        - retry
      tls:
        certResolver: le-staging
      service: api

    # Traefik dashboard (guarded)
    traefik-dashboard:
      rule: Host(`${TRAEFIK_DNS_LABEL}.${WEBSITE_DOMAIN}`)
      priority: 210
      entryPoints:
        - websecure
      middlewares:
        - security-headers-no-hsts
        - traefik-basic-auth
      tls:
        certResolver: le-staging
      service: api@internal

    # pgAdmin (guarded)
    pgadmin:
      rule: Host(`${PGADMIN_DNS_LABEL}.${WEBSITE_DOMAIN}`)
      priority: 200
      entryPoints:
        - websecure
      middlewares:
        - security-headers-no-hsts
        - traefik-basic-auth
        - pgadmin-allow-ip
      tls:
        certResolver: le-staging
      service: pgadmin

    # Flower (guarded; only works when container enabled)
    flower:
      rule: Host(`${FLOWER_DNS_LABEL}.${WEBSITE_DOMAIN}`)
      priority: 200
      entryPoints:
        - websecure
      middlewares:
        - security-headers-no-hsts
        - flower-basic-auth
        - flower-allow-ip
      tls:
        certResolver: le-staging
      service: flower

  services:
    frontend-react:
      loadBalancer:
        servers:
          - url: http://react-app:8080

    api:
      loadBalancer:
        servers:
          - url: http://api:${FASTAPI_PORT}

    django-admin:
      loadBalancer:
        servers:
          - url: http://django:${DJANGO_PORT}

    django-static:
      loadBalancer:
        servers:
          - url: http://nginx-static:8081

    pgadmin:
      loadBalancer:
        servers:
          - url: http://pgadmin:8080

    flower:
      loadBalancer:
        servers:
          - url: http://flower:5555

  middlewares:
    redirect-to-https:
      redirectScheme:
        scheme: https
        port: 443
        permanent: true

    strip-api-prefix:
      stripPrefix:
        prefixes:
          - /api

    security-headers:
      headers:
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "no-referrer-when-downgrade"
        customResponseHeaders:
          X-Frame-Options: "DENY"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Permissions-Policy: "geolocation=(), microphone=(), camera=(), payment=(), usb=()"

    security-csp:
      headers:
        contentSecurityPolicy: "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; form-action 'self'; img-src 'self' https: data:; style-src 'self' 'unsafe-inline'; script-src 'self'; font-src 'self' data:;"

    security-csp-swagger:
      headers:
        contentSecurityPolicy: "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; form-action 'self'; img-src 'self' https: data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; font-src 'self' data:; worker-src 'self' blob:;"

    security-headers-no-hsts:
      headers:
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "no-referrer-when-downgrade"
        customResponseHeaders:
          X-Frame-Options: "DENY"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Permissions-Policy: "geolocation=(), microphone=(), camera=(), payment=(), usb=()"

    traefik-basic-auth:
      basicAuth:
        users:
          - "${TRAEFIK_DASH_BASIC_USERS}"

    pgadmin-allow-ip:
      ipAllowList:
        sourceRange:
          - ${PGADMIN_ALLOWLIST}

    django-admin-allow-ip:
      ipAllowList:
        sourceRange:
          - ${DJANGO_ADMIN_ALLOWLIST}

    flower-allow-ip:
      ipAllowList:
        sourceRange:
          - ${FLOWER_ALLOWLIST}

    flower-basic-auth:
      basicAuth:
        users:
          - "${FLOWER_BASIC_USERS}"

    rate-limit:
      rateLimit:
        average: 100
        burst: 50

    retry:
      retry:
        attempts: 3
        initialInterval: 100ms
