name: CI (backend)

on:
  pull_request:
  push:

jobs:
  backend:
    name: ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [api, django]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ "${{ matrix.service }}" = "api" ]; then
            python -m pip install -r api/requirements.txt
          else
            python -m pip install -r django/requirements.txt
          fi
          python -m pip install ruff mypy

      - name: Ruff (lint)
        run: |
          if [ "${{ matrix.service }}" = "api" ]; then
            ruff check api
          else
            ruff check django
          fi

      - name: Mypy (typecheck)
        run: |
          if [ "${{ matrix.service }}" = "api" ]; then
            mypy api
          else
            mypy --exclude '.*/migrations/.*' django
          fi

      - name: Pytest (unit only, with coverage)
        env:
          DJANGO_SETTINGS_MODULE: project.settings.test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: mydatabase
          DB_USER: myuser
          DB_PASSWORD: mypassword
        run: |
          if [ "${{ matrix.service }}" = "api" ]; then
            pytest -q -m "not integration" --cov=api --cov-report=xml:coverage.xml --cov-report=term --cov-fail-under=50 -c api/pytest.ini api
          else
            cd django
            pytest -q -m "not integration" --cov=project --cov-report=xml:coverage.xml --cov-report=term --cov-fail-under=60 -c pytest.ini .
          fi
      - name: Check Django migrations
        if: matrix.service == 'django'
        working-directory: django
        run: |
          python manage.py makemigrations --check --dry-run

  backend-integration:
    name: backend-integration
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: myuser
          POSTGRES_PASSWORD: mypassword
          POSTGRES_DB: mydatabase
        ports: ['5432:5432']
        options: >-
          --health-cmd "pg_isready -U myuser -d mydatabase" --health-interval 10s --health-timeout 5s --health-retries 10
      redis:
        image: redis:7.2-alpine
        ports: ['6379:6379']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt
          pip install -r django/requirements.txt
      - name: Start Celery worker
        env:
          CELERY_BROKER_URL: redis://localhost:6379/0
          CELERY_RESULT_BACKEND: redis://localhost:6379/1
        working-directory: api
        run: |
          nohup celery -A tasks.app worker --loglevel=info &
          sleep 5
      - name: Run API integration tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: mydatabase
          DB_USER: myuser
          DB_PASSWORD: mypassword
          CELERY_BROKER_URL: redis://localhost:6379/0
          CELERY_RESULT_BACKEND: redis://localhost:6379/1
        run: |
          cd api
          pytest -q -m integration --cov=api --cov-append --cov-report=term -c pytest.ini
