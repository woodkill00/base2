{
  "user_data": "#!/bin/bash\n# Digital Ocean droplet base setup script\n# Run as root or with sudo, or via cloud-init user_data\nset -o errexit\nset -o nounset\nset -o pipefail\n\nexport DEBIAN_FRONTEND=noninteractive\nIFS=$(printf '\\n\\t')\n\n# --- Logging Functions ---\nlog() { echo -e \"\\033[1;32m[INFO]\\033[0m $1\"; }\nerr() { echo -e \"\\033[1;31m[ERROR]\\033[0m $1\" >&2; }\ntrap 'err \"Script failed at line $LINENO\"' ERR\n\n# Wait for dpkg/apt locks to be released\ndpkg_lock_wait() {\n  while fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \\\n        fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 ; do\n    echo \"Waiting for other package managers to finish...\" >&2\n    sleep 3\n  done\n}\n\nlog \"User data script started at $(date)\"\necho \"User data script started at $(date)\" | tee -a /var/log/cloud-init-output.log\n\n# --- System Update & Core Tools ---\nlog \"Updating and upgrading system packages...\"\ndpkg_lock_wait\napt-get update -y && apt-get upgrade -y\napt-get autoremove -y\n\ndpkg_lock_wait\napt-get update -y\napt-get autoremove -y\n\ndpkg_lock_wait\napt-get install -y curl python3-pip python3-venv make build-essential wget git\n\n# --- Node.js and npm Install ---\ndpkg_lock_wait\napt-get install -y nodejs npm\n\n# --- Application Setup ---\ndpkg_lock_wait\nlog \"Cloning repo to /opt/apps/base2...\"\nmkdir -p \"/opt/apps/base2\"\nif [ -d \"/opt/apps/base2\" ] && [ \"$(ls -A \"/opt/apps/base2\")\" ]; then\n  log \"/opt/apps/base2 already exists and is not empty, skipping git clone.\"\nelse\n  git clone https://github.com/woodkill00/base2.git \"/opt/apps/base2\"\nfi\n\n# --- Python Virtual Environment Setup ---\nlog \"Setting up Python virtual environment...\"\n\nVENV_PATH=\"/opt/apps/base2/venv\"\npython3 -m venv \"$VENV_PATH\"\nsource \"$VENV_PATH/bin/activate\"\nlog \"Virtual environment activated at $VENV_PATH.\"\n\nlog \"Upgrading pip in venv...\"\npip install --upgrade pip\nlog \"Core tools installed and pip upgraded in venv.\"\n\n# Ensure all subsequent commands use the venv\nexport VIRTUAL_ENV=\"$VENV_PATH\"\nexport PATH=\"$VENV_PATH/bin:$PATH\"\n\n# --- Docker Install ---\nlog \"Removing old Docker versions (if any)...\"\ndpkg_lock_wait\napt-get remove --yes docker docker-engine docker.io containerd runc || true\n\nlog \"Installing Docker and Docker Compose (official method)...\"\ndpkg_lock_wait\napt-get update -y\n\ndpkg_lock_wait\napt-get install -y ca-certificates curl gnupg lsb-release\ninstall -m 0755 -d /etc/apt/keyrings\nrm -f /etc/apt/keyrings/docker.gpg\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg\nchmod a+r /etc/apt/keyrings/docker.gpg\necho \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null\n\ndpkg_lock_wait\napt-get update -y\n\ndpkg_lock_wait\napt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin\nusermod -aG docker $(whoami)\ndocker --version\nsystemctl enable docker\nsystemctl start docker\nlog \"Docker installed and started successfully.\"\n\nlog \"Waiting for Docker to start...\"\nsleep 5\n\n\n# --- Docker Compose Standalone Install ---\nlog \"Installing standalone Docker Compose binary...\"\nDOCKER_COMPOSE_LATEST=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d '\"' -f4)\ncurl -L \"https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_LATEST}/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\nchmod +x /usr/local/bin/docker-compose\ndocker compose version\ndocker-compose --version\nlog \"Docker Compose (plugin and standalone) installed successfully.\"\n\n# --- Docker Socket Permissions (optional) ---\nif [ -S /var/run/docker.sock ]; then\n  chown $(whoami) /var/run/docker.sock || true\nfi\n\n# --- Security and System Hardening ---\nlog \"Hardening SSH configuration...\"\nsed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config\nsed -i 's/^#*PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config\nsystemctl enable ssh\nsystemctl start ssh\nsystemctl reload sshd\n\nlog \"Setting up UFW firewall...\"\ndpkg_lock_wait\n# Robust retry for ufw install if dpkg lock error occurs\nfor i in {1..10}; do\n  apt-get install -y ufw && break\n  log \"ufw install failed due to lock, retrying in 5s (attempt $i)...\"\n  sleep 5\n  dpkg_lock_wait\ndone\nufw default deny incoming\nufw default allow outgoing\nufw allow 22/tcp    # SSH\nufw allow 80/tcp    # HTTP\nufw allow 443/tcp   # HTTPS\n# Add more ports as needed for your services\nufw --force enable\nufw status verbose\n\ntouch /var/log/do_base_complete\nlog \"User data script completed at $(date)\"\necho \"User data script completed at $(date)\" | tee -a /var/log/cloud-init-output.log\n\nlog \"Rebooting system to complete setup...\"\necho \"Rebooting system to complete setup...\" | tee -a /var/log/cloud-init-output.log\nsleep 2\nreboot\n",
  "droplet_id": 536126052
}